"use strict";var s={brightness:"0.5",contrast:"1",sepia:"0",grayscale:"0"},i={enabled:!1,global:!0,overlay:s};async function f(){return(await chrome.storage.local.get(["_global"]))._global}async function h(){return chrome.storage.local.set({_global:structuredClone(s)})}chrome.runtime.onInstalled.addListener(()=>{f().then(e=>{e||h()})});function l(e){if(!(e!=null&&e.url))return!1;try{return new URL(e.url).hostname}catch(a){return!1}}async function o(e=!1){let a={};[16,32,48,128].forEach(t=>{a[t]=`../assets/${e?"icon":"inactive"}${t}.png`}),await chrome.action.setIcon({path:a})}function c(e){return e!=null&&e.id?chrome.scripting.executeScript({target:{tabId:e.id},files:["public/js/content.js"]}):Promise.resolve(null)}async function u(e,a=!1){let t=structuredClone(i),r=l(e);if(!r)return t;let n=await chrome.storage.local.get([r]);if(n[r]&&(t=n[r]),t.global&&!a){let{_global:b}=await chrome.storage.local.get(["_global"]);t.overlay=b}return t}async function d(e,a,t=!1){let r=l(e);if(r){if(a.global&&!t){await chrome.storage.local.set({_global:a.overlay});let n=await u(e,!0);a.overlay=n.overlay}chrome.storage.local.set({[r]:a},()=>{c(e).then(()=>o(a.enabled))})}}async function y(e,a=!1){if(a)await chrome.storage.local.clear(),await h();else{let t=l(e);t&&await chrome.storage.local.set({[t]:i})}e&&c(e).then(()=>o(!1))}async function m(e){if(!(e!=null&&e.id))return!1;try{await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>!0})}catch(a){return!1}return!0}chrome.runtime.onMessage.addListener((e,a,t)=>{if(a.id!==chrome.runtime.id)return!1;let{payload:r}=e;switch(e.type){case"getTab":return chrome.tabs.query({active:!0},n=>t(n[0])),!0;case"isScriptableTab":return m(...r).then(n=>t(n)),!0;case"getGlobalSettings":return f().then(n=>t(n)),!0;case"getTabSettings":return u(...r).then(n=>t(n)),!0;case"saveTabSettings":return d(...r).then(n=>t(n)),!0;case"resetSettings":return y(...r).then(()=>t()),!0}});async function g(e,a=!1){if(!await m(e))return o(!1);let t=await u(e,!0);a?await d(e,{...t,enabled:!t.enabled},!0):c(e).then(()=>o(t.enabled))}chrome.commands.onCommand.addListener((e,a)=>{e==="toggle-dimmer"&&g(a,!0)});chrome.tabs.onActivated.addListener(e=>{e.tabId&&chrome.tabs.get(e.tabId).then(a=>g(a))});chrome.tabs.onUpdated.addListener((e,a,t)=>{a.status==="complete"&&t.active&&chrome.tabs.get(e).then(r=>g(r))});
