"use strict";var i={brightness:"0.5",contrast:"1",sepia:"0",grayscale:"0"},s={enabled:!1,global:!0,overlay:i};async function f(){return(await chrome.storage.local.get(["_global"]))._global}async function d(){return chrome.storage.local.set({_global:structuredClone(i)})}chrome.runtime.onInstalled.addListener(()=>{f().then(e=>{e||d()})});function o(e){if(!(e!=null&&e.url))return!1;try{return new URL(e.url).hostname}catch(r){return!1}}async function l(e){if(!(e!=null&&e.id))return!1;try{await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>!0})}catch(r){return!1}return!0}function c(e){e!=null&&e.id&&chrome.tabs.query({url:`*://${o(e)}/*`},r=>{r.forEach(t=>{!(t!=null&&t.id)||!l(t)||chrome.scripting.executeScript({target:{tabId:t.id},files:["public/js/content.js"]})})})}async function u(e,r=!1){let t=structuredClone(s),a=o(e);if(!a)return t;let n=await chrome.storage.local.get([a]);if(n[a]&&(t=n[a]),t.global&&!r){let{_global:m}=await chrome.storage.local.get(["_global"]);t.overlay=m}return t}async function h(e,r,t=!1){let a=o(e);if(a){if(r.global&&!t){await chrome.storage.local.set({_global:r.overlay});let n=await u(e,!0);r.overlay=n.overlay}chrome.storage.local.set({[a]:r},()=>c(e))}}async function y(e,r=!1){if(r)await chrome.storage.local.clear(),await d();else{let t=o(e);t&&await chrome.storage.local.set({[t]:s})}e&&c(e)}chrome.runtime.onMessage.addListener((e,r,t)=>{if(r.id!==chrome.runtime.id)return!1;let{payload:a}=e;switch(e.type){case"getTab":return chrome.tabs.query({currentWindow:!0,active:!0},n=>t(n[0])),!0;case"isScriptableTab":return l(...a).then(n=>t(n)),!0;case"getGlobalSettings":return f().then(n=>t(n)),!0;case"getTabSettings":return u(...a).then(n=>t(n)),!0;case"saveTabSettings":return h(...a).then(n=>t(n)),!0;case"resetSettings":return y(...a).then(()=>t()),!0}});async function g(e,r=!1){if(!await l(e))return;let t=await u(e,!0);r?await h(e,{...t,enabled:!t.enabled},!0):c(e)}chrome.commands.onCommand.addListener((e,r)=>{e==="toggle-dimmer"&&g(r,!0)});chrome.tabs.onActivated.addListener(e=>{e.tabId&&chrome.tabs.get(e.tabId).then(r=>g(r))});chrome.tabs.onUpdated.addListener((e,r,t)=>{r.status==="complete"&&t.active&&chrome.tabs.get(e).then(a=>g(a))});
