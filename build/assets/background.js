import{d as n}from"./chrome.js";async function r(t){const e=await chrome.tabs.query({url:`*://${t.website.hostname}/*`});e&&await Promise.all(e.map(async a=>{if(a.id)try{await chrome.scripting.executeScript({target:{tabId:a.id},files:["assets/content.js"]})}catch{}}))}async function i(){const t=await chrome.tabs.query({currentWindow:!0,active:!0}),e=structuredClone(n),a=await chrome.storage.local.get(["_global"]);if(a._global&&(e.global=a._global),!t.length||!t[0].id||!t[0].url)return e;try{await chrome.scripting.executeScript({target:{tabId:t[0].id},func:()=>!0})}catch{return e}const{hostname:s}=new URL(t[0].url);e.website.hostname=s;const o=await chrome.storage.local.get([s]);return o[s]&&(e.website=o[s]),e}async function c(t){if((t.website.hostname==="*"||t.website.mode==="global")&&await chrome.storage.local.set({_global:t.global}),t.website.hostname==="*")return;const e=await i();await chrome.storage.local.set({[e.website.hostname]:t.website}),await r(t)}chrome.runtime.onMessage.addListener((t,e,a)=>{if(e.id===chrome.runtime.id)switch(t.type){case"getSettings":return i().then(s=>a(s)),!0;case"saveSettings":c(t.payload);break;case"resetSettings":chrome.storage.local.clear().then(()=>r(n));break}});chrome.commands.onCommand.addListener(async t=>{if(t!=="toggle-dimmer")return;const e=await i();e&&(e.website.on=!e.website.on,await c(e))});chrome.tabs.onActivated.addListener(async t=>{t.tabId&&await r(await i())});
