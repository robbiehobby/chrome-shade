import{d as n}from"./chrome.js";async function i(e,t=null){if(t!=="reset"&&e.website.hostname==="*")return;const a=await chrome.tabs.query({url:`*://${e.website.hostname}/*`});a&&await Promise.all(a.map(async s=>{try{if(!s.id)return;await chrome.tabs.sendMessage(s.id,{action:"update",payload:{settings:e,type:t}})}catch{}}))}async function o(e){let t;e?t=await chrome.tabs.get(e):t=(await chrome.tabs.query({currentWindow:!0,active:!0})).pop();const a=structuredClone(n),s=await chrome.storage.local.get(["_global"]);if(s._global&&(a.global=s._global),!(t!=null&&t.id)||!t.url)return a;try{await chrome.scripting.executeScript({target:{tabId:t.id},func:()=>!0})}catch{return a}const{hostname:r}=new URL(t.url);a.website.hostname=r;const c=await chrome.storage.local.get([r]);return c[r]&&(a.website=c[r]),a}async function l(e){if((e.website.hostname==="*"||e.website.mode==="global")&&await chrome.storage.local.set({_global:e.global}),e.website.hostname==="*")return;const t=await o();await chrome.storage.local.set({[t.website.hostname]:e.website}),await i(e)}chrome.runtime.onMessage.addListener((e,t,a)=>{switch(e.type){case"getSettings":return o().then(s=>a(s)),!0;case"saveSettings":l(e.payload);break;case"resetSettings":chrome.storage.local.clear().then(()=>i(n,"reset"));break}});chrome.commands.onCommand.addListener(async e=>{const t=await o();switch(e){case"activate":t.website.on=!t.website.on;break;case"global":t.website.mode=t.website.mode==="global"?"website":"global";break}await l(t)});chrome.tabs.onUpdated.addListener(async(e,t)=>{t.status==="complete"&&await i(await o(e))});chrome.tabs.onActivated.addListener(async e=>{e.tabId&&await i(await o(e.tabId),"activated")});
